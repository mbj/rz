#!/usr/bin/env ruby
$: << File.expand_path(File.join(File.dirname(__FILE__),'..','lib'))

require 'rz/client'

class Client
  include RZ::Client

  def run
    yield self
  ensure
    zmq_cleanup
  end

  def initialize
    initialize_client(
      :services => {
        :service_a => "tcp://127.0.0.1:4000",
        :service_b => "tcp://127.0.0.1:4010",
        :service_c => "tcp://127.0.0.1:4020"
      }, 
      :identity => "client.#{Process.pid}"
    )
  end
end

Client.new.run do |client|
  %w(service_a service_b service_c).map(&:to_sym).each do |service|
    puts 'executing 100 asynchronous requests'

    100.times do |i|
      client.request service, { :name => :eval, :arguments => ["sleep 1; #{i}"] }
    end

    puts 'receiving answers'

    a = Time.now

    100.times do |i|
      x = client.receive service, :timeout => 100
      p "x: #{x} i: #{i}"
    end

    b = Time.now

    puts "did work in: #{b-a} seconds"
  end
end
