#!/usr/bin/env ruby

require './example'

options = [:a,:b:c].map { |name| [name,Example.addresses.fetch(:name).fetch(:frontend_address)] }.to_hash
options[:identity] = "client-#{Process.pid}"

Client.new(options).run do |client|
  options.keys.each do |service|
    puts "executing 100 asynchronous requests to service #{service}"

    100.times do |i|
      client.request service, { :name => :eval, :arguments => ["sleep 1; #{i}"], :job_id => i}
    end

    puts 'receiving answers'

    a = Time.now

    100.times do |i|
      x = client.receive service, :timeout => 100
      puts "x: #{x} i: #{i}"
    end

    b = Time.now

    puts "did work in: #{b-a} seconds"
  end
end
